

<template>
    <div>
        <Nar></Nar>
       <div style="text-align: center" id="chart"></div>
        <div class="maine">
            <div class="title">“特斯拉刹车失灵车主维权风波”</div>
            <div class="content">
                <p>通过其事理图谱，我们能够清晰地描绘事件的发展脉络以及主要诱发因素。将维权行动作为中心节点来观察，可以发现导致最终维权行为发生的因素主要包括以下几点：</p>
                <p>技术问题：与“维权行动”直接相关的事件节点为“刹车失灵”，且“刹车失灵”事件同时引发了“介入调查”、“媒体报道”、“公开道歉”等事件。这表明该事件的根本触发因素是特斯拉汽车的刹车系统出现失灵问题，这导致了车主的担忧和不满。技术问题直接危及车主和其他车辆乘客的安全感，引发了他们的情感波动。</p>
                <p>组织和领导：“维权行动”节点的相关论元包括“车主”、“组织示威”、“提起诉讼”。随着事件的升级，一些车主和相关组织开始积极组织联合维权活动。这些组织和领导者在事件中发挥了协调作用，推动事件进一步发展。</p>
                <p>社交媒体传播：“维权行动”的前序节点除“刹车失灵”外还包括“媒体报道”。车主通过社交媒体平台积极分享了他们的个人经历和对特斯拉刹车失灵问题的看法。这些信息在社交媒体上迅速传播，吸引了更多的人关注和参与。社交媒体的强大传播力使事件的影响范围得以迅速扩大，形成了一个持续增长的舆论场。</p>
                <p>这些因素相互交织在一起，造成了最后的群体性维权行为，塑造了“特斯拉刹车失灵车主维权风波”事件的发展轨迹。这一事件突显了群体性事件往往是由社会矛盾、公共事件、社交媒体和领导者或组织等多重因素共同驱动的结果。这些因素相互影响，共同促成了群体性事件的发生和发展。
                    通过深入挖掘事件的各种诱发因素，我们能够更全面地了解群体性事件的本质，以及如何通过多角度的分析来揭示事件的动态和演进。这种方法不仅有助于为类似事件提供深刻的解释，还为未来的研究和干预提供了有价值的洞察。</p>
            </div>
            <a-divider />
            <div class="title">“留学生江歌被害案”</div>
            <div class="content">
                <p>社会反应随着事件的发展呈现出阶段性的演变：事件初期，公众对江歌的悲惨遭遇感到愤怒和悲痛，对凶手的行为表示极度谴责。社交媒体成为表达情感的重要平台，大量用户分享对事件的情感反应。愤怒情绪催生了事件的首波舆论高潮。强烈的公众反应影响了媒体报道和评论。随着舆论发酵，媒体跟进报道加剧了事件的关注度。公众对事件的强烈情感成为推动媒体关注的动力。媒体的深度分析和评论进一步加强了公众情绪，形成了舆论压力，促使加拿大司法系统对事件做出应对。部分公众组织和个人发起了抗议活动，要求加拿大政府保障留学生权益和安全。示威、抗议等集体行动成为表达不满和要求变革的途径。这些行动进一步将事件置于公众关注的焦点。随着事件发展，对加拿大司法系统的判决提出质疑。公众开始思考事件背后可能存在的社会结构问题，以及司法公正性等议题。社会反思促使更广泛的讨论，对事件的关注由个案拓展为更深层次的问题思考。</p>
                <p>通过这一案例分析，我们看到群体性事件的反应并非静态的，而是动态发展的过程。不同阶段的反应在一定程度上相互影响，前一阶段的情绪和行动可能催化或引导后续阶段的发展，推动事件呈现出复杂的发展趋势和多样的结果。深入了解这些反应的动态性，有助于我们更准确地预测事件的发展趋势和可能的社会结果。同时，这也提醒我们在研究群体性事件时需要关注反应的多维度变化，以获得更全面的认识。</p>
            </div>
            <a-divider />
            <div class="title">“江西南昌发生重大交通事故”</div>
            <div class="content">
                <p>该事件的事理图谱重要节点和事件间的因果关系如表所示，“事故发生”节点为该事件的起点，随后引发了伤者救治、赔偿协商、安全警示等多种后续事件。同时，在事故发生后的救援行动也至关重要。这个节点可能引发多方向性的演化。例如，救援行动的及时性和有效性可能影响伤者救治和事故后续处理，同时也受到交通管制实施和其他因素的影响。事故发生后，相关部门会启动事故调查。调查结果可能影响赔偿协商、安全警示等方向的发展。此外，调查的深入也可能受到媒体报道和其他利益相关者的影响。伤者救治是事故后的紧要环节。救治的效果可能受到救援行动和医疗资源等多方面因素的影响，同时也可能会对赔偿协商和安全警示等产生影响。</p>
                <p>总的来说，事件的演化路径并不局限于单一的线性发展，还可以呈现出多个分支和方向。在事件或事物的发展过程中，由于不同因素的影响，可能产生多种可能的走向。不同节点之间的影响在当前阶段和长期层面上产生多层次的传递和扩展，这些不同的路径可能相互交叉、相互影响，形成一个复杂的网络结构。因此，多方向演化和多级别传递的特点凸显了事件发展的多样性和复杂性。</p>
                <p>以“江西南昌发生重大交通事故”事件为例，该事件的事理图谱如图所示，对该事件事理图谱中的节点进行中心性分析，分析结果如表所示。“救援行动展开”具有较高的接近中心性和介数中心性。这意味着救援行动节点在整个事件中与其他节点有较多的连接关系，可能充当信息传递的关键节点，影响着其他节点的演化。接近中心性为0.85，说明该节点与其他节点之间的平均最短路径长度相对较短，节点在信息传递方面比较便捷。介数中心性为1.58，表示救援行动展开节点在所有最短路径中作为中间节点的频率较高，可能在信息传递中充当了关键的中介者。综合来看，救援行动展开节点在图谱中起到了关键的桥梁作用，对于事件的发展和信息传递起到了重要的作用。事故发生节点的度中心性为0.33，表示该节点的度数相对较低，与其他节点的连接较少。接近中心性为0.6，说明该节点与其他节点之间的平均最短路径长度相对较短，节点在信息传递方面较为便捷。然而，介数中心性为0，表示事故发生节点在所有最短路径中没有作为中间节点出现的频率，可能不会在信息传递中扮演关键角色。综合来看，事故发生节点虽然是事件的起点，但在整个图谱中的作用相对较小，可能在信息传递中没有起到明显的中介作用。</p>
            </div>
            <a-divider />
            <div class="title">“员工实名举报中国人寿大量造假”</div>
            <div class="content">
                <p>该事件的主要参与者为对中国人寿的违法行为进行实名举报的中国人寿员工及造假行为的实施者中国人寿公司；事件的次要参与者包括造假行为的受害者与介入调查的监管部门；外部参与者为对该事件进行曝光报道的媒体和对事件密切关注的公众。直接参与者，即员工，可能出于维护权益、揭露不公正行为等动机进行实名举报。不同参与者的行动方式也有所不同，员工通过实名举报的方式将违法行为曝光，媒体通过报道和调查揭示真相，监管机构通过调查和处罚维护市场秩序。</p>
                <p>总的来说，群体性事件的参与者通常因共同的目标、利益或情绪而聚集在一起，展开集体行动。主要参与者、次要参与者和外部参与者各自具有不同的动机、目标、组织能力和社会背景。对群体性事件的参与者进行分析可以帮助我们更好地了解事件的背后动因和参与者的行为逻辑，从而更好地评估风险和制定应对策略。</p>
            </div>
            <a-divider />
            <div class="title">“苏州一建筑发生坍塌”</div>
            <div class="content">
                <p>在事件发生的初期，事件的主要参与者为坍塌事件的受害者。社会各界开始逐渐接收关于坍塌事件的信息。社交媒体平台成为主要的信息传播渠道，作为外部参与者的人们开始表达疑虑、关切和困惑的情感。大量分享事件的新闻报道和图片，以及讨论事件可能的发生原因，构成了初始阶段的行为特征。</p>
                <p>随着事件的发展，紧急救援行动开始展开。社交媒体上的行为模式逐渐从信息获取转变为呼唤救援、转发救援信息和寻求帮助。主要参与者受害群众开始在平台上发布救援需求，同时表达对次要参与者救援人员的敬意和感激之情。当事件伤亡情况得到确认后，情感表达成为社交媒体上的主要行为。作为外部参与者的公众发布悼念信息、照片和视频，表达哀悼之情。社会媒体平台上涌现出大量的悼念帖子和纪念活动，情感性行为模式达到高峰。</p>
                <p>随着事件进一步发展，社会开始关注事件的责任问题。社交媒体上的行为重心转向呼吁公正、讨论责任追究和对事件的主要参与者——涉事方的不满。评论和转发的内容多涉及调查进展、相关政府机构的行动以及责任方的言论，行为模式逐渐呈现集中的讨论。随着事件的持续影响，媒体持续报道事件的后续进展和影响。社交媒体上的行为逐渐变得较为客观，人们开始分享相关报道和评论。建筑安全问题引起关注，公众开始呼吁强化安全监管和规范，行为模式呈现社会问题解决的倾向。</p>
                <p>随着时间推移，舆论逐渐平息，社交媒体上的行为逐渐减少。人们的情感反应逐渐淡化，但事件对建筑安全意识和社会关注的长期影响仍然存在。社交媒体上的行为可能转向其他热点话题，但事件“苏州一建筑发生坍塌”所引发的行为模式演化仍会留下痕迹。</p>
                <p>通过对事件“苏州一建筑发生坍塌”的不同发展阶段进行详细分析，我们可以清晰地看到三种参与者的行为模式是如何随着时间变化而演化的。从初始的信息获取到后续的情感表达、责任追究，再到长期的安全关切，每个阶段都展现了不同的情感、动机和关注焦点。这种行为模式的演化不仅反映了事件对人们情感和认知的影响，也揭示了社会在危机事件面前的团结、呼吁和思考。</p>
            </div>
        </div>
    </div>
</template>
<script>
import * as d3 from 'd3'
import Nar from './Nar.vue';
import axios from "axios";
import { DataSet, Network } from 'vis-network/standalone';
import {useStore} from "vuex";
export default {
  name: 'CirclePacking',
  components: { Nar },
  data() {
    return {
      nodes:new DataSet(),
      edges:new DataSet(),
      data: null,
      select_type:null,//
      offset:0,
    }
  },
  mounted() {
    this.loadData()
  },
  methods: {
    async hidePopupWindow() {
  // 获取悬浮窗口元素
  const popupWindow = document.getElementById('popupWindow');
  if (popupWindow) {
    // 移除悬浮窗口元素
    document.body.removeChild(popupWindow);
  }
},

    async openPopupWindow(d) {
  // 创建一个新的 div 元素作为悬浮窗口
  const popupWindow = document.createElement('div');
  popupWindow.id = 'popupWindow';
  popupWindow.style.position = 'absolute';
  popupWindow.style.zIndex = '10';
  popupWindow.style.background = 'transparent';
popupWindow.style.top = '4%';  // 设置宽度
      popupWindow.style.left = '33%';  // 设置宽度
  popupWindow.style.borderRadius = '50%';  // 设置为圆形
  popupWindow.style.width = '700px';  // 设置宽度
  popupWindow.style.height = '700px';  // 设置高度
  // popupWindow.style.padding = '10px';
      popupWindow.style.overflow = 'hidden';
  // popupWindow.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
  document.body.appendChild(popupWindow);

  // 创建一个新的 div 元素作为 vis-network 的容器
  const networkContainer = document.createElement('div');
  networkContainer.style.width = '700px';
  networkContainer.style.height = '700px';
  networkContainer.style.borderRadius = '50%';
  popupWindow.appendChild(networkContainer);
    // 创建一个新的 div 元素作为按钮的容器
  const buttonContainer = document.createElement('div');
  buttonContainer.style.display = 'flex';
  buttonContainer.style.justifyContent = 'space-between';
  buttonContainer.style.position = 'absolute';
  buttonContainer.style.bottom = '50%';  //
buttonContainer.style.transform = 'translateY(50%)';  //
  buttonContainer.style.left = '10px';
  buttonContainer.style.right = '10px';
  popupWindow.appendChild(buttonContainer);

  // 创建左箭头按钮
const leftButton = document.createElement('button');
leftButton.style.border = 'none';  // 移除按钮的默认样式
leftButton.style.background = 'transparent';  // 移除按钮的默认样式
const leftIcon = document.createElement('i');
leftIcon.classList.add('fas', 'fa-chevron-circle-left');  // 使用 Font Awesome 的左箭头图标
leftIcon.style.fontSize = '50px';  // 增大图标的大小
leftButton.appendChild(leftIcon);
  leftButton.style.color = 'white';
  leftButton.style.fontSize = '2em';
  leftButton.style.cursor = 'pointer';
  leftButton.style.transition = 'transform 0.3s ease';
  leftButton.onmouseover = function() {
    this.style.transform = 'scale(1.2)';
  };
  leftButton.onmouseout = function() {
    this.style.transform = 'scale(1)';
  };
  leftButton.onclick = async () => {
    this.offset -= 1;  // 更新 offset 参数
    await this.getEventData(this.offset);
    this.network.setData({
      nodes: this.nodes,
      edges: this.edges
    });
  };
  buttonContainer.appendChild(leftButton);
  //创建详情按钮
const detailsButtonContainer = document.createElement('div');
detailsButtonContainer.style.position = 'absolute';
detailsButtonContainer.style.bottom = '10px';  // Adjust this value to position the button
detailsButtonContainer.style.left = '50%';
detailsButtonContainer.style.transform = 'translateX(-50%)';
popupWindow.appendChild(detailsButtonContainer);
// 在创建 detailsButton 之前
const store = this.$store;
// Create the details button
const detailsButton = document.createElement('button');
detailsButton.style.background = 'transparent';  // 移除按钮的默认样式
      detailsButton.style.border = 'none';  // 移除按钮的默认样式
// detailsButton.textContent = 'Details';
const detailIcon = document.createElement('i');
detailIcon.classList.add('fas', 'fa-magnifying-glass-chart');  // 使用 Font Awesome 的左箭头图标
detailIcon.style.fontSize = '50px';  // 增大图标的大小
detailsButton.appendChild(detailIcon);
detailsButton.style.color = 'white';
detailsButton.style.fontSize = '2em';
detailsButton.style.cursor = 'pointer';
detailsButton.style.transition = 'transform 0.3s ease';
detailsButton.onmouseover = function() {
  this.style.transform = 'scale(1.2)';
};
detailsButton.onmouseout = function() {
  this.style.transform = 'scale(1)';
};
detailsButton.onclick = () => {
  // Navigate to the Vue page and pass the current event as a parameter
  // Replace 'YourVuePage' with the actual path to your Vue page
  this.hidePopupWindow();
    console.log(this.eventDataResponse.data.topic.event_topic)
    store.commit('getTitle',this.eventDataResponse.data.topic.event_topic);
  window.location.href = `#/example?event=${encodeURIComponent(JSON.stringify(this.eventDataResponse.data.topic.event_topic))}`;
};
detailsButtonContainer.appendChild(detailsButton);
  // 创建右箭头按钮
const rightButton = document.createElement('button');
rightButton.style.border = 'none';  // 移除按钮的默认样式
rightButton.style.background = 'transparent';  // 移除按钮的默认样式
const rightIcon = document.createElement('i');
rightIcon.classList.add('fas', 'fa-chevron-circle-right');  // 使用 Font Awesome 的右箭头图标
rightIcon.style.fontSize = '50px';  // 增大图标的大小
rightButton.appendChild(rightIcon);
  rightButton.style.color = 'white';
  rightButton.style.fontSize = '2em';
  rightButton.style.cursor = 'pointer';
  rightButton.style.transition = 'transform 0.3s ease';
  rightButton.onmouseover = function() {
    this.style.transform = 'scale(1.2)';
  };
  rightButton.onmouseout = function() {
    this.style.transform = 'scale(1)';
  };
  rightButton.onclick = async () => {
    this.offset += 1;  // 更新 offset 参数
    await this.getEventData(this.offset);
    this.network.setData({
      nodes: this.nodes,
      edges: this.edges
    });
  };
  buttonContainer.appendChild(rightButton);
  // 调用 getEventData 函数获取事件数据
  await this.getEventData();

  // 使用 vis-network 创建图谱
  const data = {
    nodes: this.nodes,
    edges: this.edges
  };
  const options = {};  // 你可以在这里设置 Network 的选项
  this.network = new Network(networkContainer, data, options);
},
async getEventData(offset=0) {
  // 获取事件数据
  const response = await axios.get('/api/type-data', {
    params: { event_topic: this.select_type , offset: offset },
  });
  const eventData = response.data;
  this.eventDataResponse = response;

  console.log(response)
  // 更新节点和边
  this.nodes.clear();
  this.edges.clear();
  const nodeSet = new Set(); // 使用Set来存储已添加的节点
  for (const event of eventData.events) {
    console.log(event.event_desc)
    // 如果subject不为'NON'且未被添加过，则添加subject节点
    if (event.subject !== 'NON' && !nodeSet.has(event.subject)) {
      this.nodes.add({ id: event.subject, label: event.subject, color: 'lightblue' , font: { size: 20 }});
      nodeSet.add(event.subject);
    }
    // 如果predicate不为'NON'且未被添加过，则添加predicate节点
    if (event.predicate !== 'NON') {
      this.nodes.add({ id: event.id, label: event.predicate, color: 'pink', font: { size: 30 } });

    }
    // 如果object不为'NON'且未被添加过，则添加object节点
    if (event.object !== 'NON' && !nodeSet.has(event.object)) {
      this.nodes.add({ id: event.object, label: event.object, color: 'lightblue', font: { size: 20 } });
      nodeSet.add(event.object);
    }

    // 如果subject和predicate都不为'NON'，则添加边
    if (event.subject !== 'NON' && event.predicate !== 'NON') {
      this.edges.add({ from: event.subject, to: event.id, color: 'lightgray' });
    }
    // 如果predicate和object都不为'NON'，则添加边
    if (event.predicate !== 'NON' && event.object !== 'NON') {
      this.edges.add({ from: event.id, to: event.object, color: 'lightgray' });
    }
  }

  for (const relation of eventData.time_relations) {
    const fromEvent = eventData.events.find(event => event.id === relation.event1_id);
    const toEvent = eventData.events.find(event => event.id === relation.event2_id);
    if (fromEvent && toEvent) {
      this.edges.add({
      id: `time-relation-${relation.event1_id}-${relation.event2_id}`,
        from: fromEvent.id,
        to: toEvent.id,
        color: '#c06c84',
        arrows: 'to',
        width: 5,
      });
    }
  }

  for (const relation of eventData.causal_relations) {
    const fromEvent = eventData.events.find(event => event.id === relation.event1_id);
    const toEvent = eventData.events.find(event => event.id === relation.event2_id);
    if (fromEvent && toEvent) {
      this.edges.add({
      id: `causal-relation-${relation.event1_id}-${relation.event2_id}`,
        from: fromEvent.id,
        to: toEvent.id,
        color: '#355c7d',
        dashes: [20, 20] ,
        arrows:'to',
        width: 5,
      });
    }
  }
  this.showTimeRelations = true;
  this.showCausalRelations = true;
},
    loadData() {
      d3.json("src/components/static/json/data.json").then(data => {
        this.data = data
        this.drawChart()
      })
    },
    drawChart() {
      const width = 1000
      const height = 1000
      let focus=null
      let view=null
      const svg = d3.select("#chart")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .style("cursor","pointer")
        .on("click", () => zoom(root));

      const pack = d3.pack()
        .size([width, height])
        .padding(2)

      const root = d3.hierarchy(this.data)
        .sum(d => d.size)
        .sort((a, b) => b.value - a.value);

      focus = root;
      const nodes = pack(root).descendants();

      view = [root.x, root.y, root.r * 2];

      const color = d3.scaleSequential(d3.interpolateBlues)  // 创建一个蓝色色系的颜色比例尺
  .domain([0, 3]);  // 设置颜色比例尺的定义域为[0, 3]

const circle = svg.selectAll("circle")
  .data(nodes)
  .enter().append("circle")
  .attr("class", d => d.parent ? d.children ? "node" : "node node--leaf" : "node node--root")
  .style("fill", d => color(3-d.depth))  // 使用颜色比例尺根据节点的深度设置颜色
  .on("click", (event, d) => {
    if (focus !== d) zoom(d), event.stopPropagation();
    this.hidePopupWindow();
    if (d.depth === 2) {
      this.select_type=d.data.name;
      console.log(this.select_type)
    this.openPopupWindow(d);
  }



  })
  .on("mouseover", function(event, d) {  // 修改这一行
    d3.select(this).style("stroke", "#999").style("stroke-width", "4px");
    tooltip.style("visibility", "visible")
      .text(`${d.data.name} (${d.value} , ${Math.round(100 * d.value / root.value)}%)`)
      .style("left", (event.pageX + 10) + "px")  // 修改这一行
      .style("top", (event.pageY - 10) + "px");  // 修改这一行
  })
  .on("mouseout", function() {  // 添加这一行
    d3.select(this).style("stroke", null);
    tooltip.style("visibility", "hidden");// 添加这一行
  });  // 添加这一行
const tooltip = d3.select("body").append("div")  // 添加这一行
    .data(nodes)
  .style("position", "absolute")  // 添加这一行
  .style("z-index", "10")  // 添加这一行
  .style("visibility", "hidden")  // 添加这一行
  .style("background", "white")  // 添加这一行
  .style("border-radius", "5px")  // 添加这一行
  .style("padding", "10px")  // 添加这一行
  .style("box-shadow", "0 0 10px rgba(0,0,0,0.5)") // 添加这一行
  .text(d => `${d.data.name} (${d.value} , ${Math.round(100 * d.value / root.value)}%)`);  // 添加这一行
const text = svg.selectAll("text")
  .data(nodes)
  .enter().append("text")
  .attr("class", "label")
  .style("fill-opacity", d => d.parent === root ? 1 : 0)
  .style("display", d => d.parent === root ? "inline" : "none")
    .style("text-anchor", "middle")  // 添加这一行
  .text(d => `${d.data.name} `);  // 修改这一行


      zoomTo([root.x, root.y, root.r * 2]);

      function zoomTo(v) {
        const k = width / v[2];
        const x = width / 2 - v[0] * k;  // 修改这一行
        const y = height / 2 - v[1] * k;  // 修改这一行

        view = v;

        circle.attr("transform", d => `translate(${(d.x * k + x)},${(d.y * k + y)})`)  // 修改这一行
              .attr("r", d => d.r * k);

        text.attr("transform", d => `translate(${(d.x * k + x)},${(d.y * k + y)})`)  // 修改这一行
            .style("fill-opacity", d => d.parent === focus ? 1 : 0)
            .style("display", d => d.parent === focus ? "inline" : "none");
      }

      function zoom(d) {
        const focus0 = focus;

        focus = d;

        const transition = svg.transition()
            .duration(750)
            .tween("zoom", d => {
              const i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2]);
              return t => zoomTo(i(t));
            });

        text
          .filter(function(d) { return d.parent === focus || this.style.display === "inline"; })
          .transition(transition)
          .style("fill-opacity", d => d.parent === focus ? 1 : 0)
          .on("start", function(d) { if (d.parent === focus) this.style.display = "inline"; })
          .on("end", function(d) { if (d.parent !== focus) this.style.display = "none"; });
      }
    }
  }
}
</script>

<style scoped>
.node {
  cursor: pointer;
}

.node:hover {
  stroke: #ffffff;
  stroke-width: 1.5px;
}

.node--leaf {
  fill: white;
}

.label {
  font: 11px "Helvetica Neue", Helvetica, Arial, sans-serif;
  text-anchor: middle;
  text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
}

.label,
.node--root,
.node--leaf {
  pointer-events: none;
}
</style>

<style>
.maine{
    border: 3px solid #fff;
    border-radius: 8px;
    margin:30px 100px ;
    background-color: #F0F8FF;
    padding: 30px;
}
.title{
    font-family: 'Palanquin Dark', sans-serif;
    font-weight: 800;
    font-size: 18px;
    color: 	rgb(45, 45, 45);
    margin-bottom: 10px;
}
p{ text-indent:2em; padding:0px; margin:0px; }
</style>
    